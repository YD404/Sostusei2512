using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.IO;
using System.Collections;
using System.Collections.Generic;

/// <summary>
/// Waiting状態で画像と名言のペアを表示するコンポーネント。
/// MessagePairs.jsonから読み込み、ランダムに切り替え表示する。
/// </summary>
public class QuoteCardDisplay : MonoBehaviour
{
    [Header("UI References")]
    [Tooltip("画像を表示するRawImage")]
    [SerializeField] private RawImage quoteImage;

    [Tooltip("名言テキスト")]
    [SerializeField] private TextMeshProUGUI quoteText;

    [Tooltip("著者名テキスト（by OO）")]
    [SerializeField] private TextMeshProUGUI authorText;

    [Header("Settings")]
    [Tooltip("次のカードに切り替えるまでの時間（秒）")]
    [SerializeField] private float displayInterval = 5.0f;

    // ファイルパス
    private string MessagePairsPath => Path.Combine(Application.streamingAssetsPath, "MessagePairs.json");
    private string CaptureDir => Path.Combine(Application.streamingAssetsPath, "capture");

    // ペアデータリスト
    private List<MessagePairData> pairs = new List<MessagePairData>();
    private Coroutine displayCoroutine;

    /// <summary>
    /// 名言カード表示を開始する
    /// </summary>
    public void ShowQuoteCard()
    {
        // データ読み込み
        LoadMessagePairs();

        if (pairs.Count == 0)
        {
            Debug.LogWarning("[QuoteCardDisplay] 表示するペアデータがありません。");
            ClearDisplay();
            return;
        }

        // 既存のコルーチンを停止
        StopLoop();

        // 表示ループ開始
        displayCoroutine = StartCoroutine(DisplayLoop());
        Debug.Log($"[QuoteCardDisplay] 表示開始: {pairs.Count}件のペアデータ");
    }

    /// <summary>
    /// 名言カード表示を停止する
    /// </summary>
    public void HideQuoteCard()
    {
        StopLoop();
        ClearDisplay();
        Debug.Log("[QuoteCardDisplay] 表示停止");
    }

    private void LoadMessagePairs()
    {
        pairs.Clear();

        if (!File.Exists(MessagePairsPath))
        {
            Debug.Log("[QuoteCardDisplay] MessagePairs.jsonが見つかりません。");
            return;
        }

        try
        {
            string json = File.ReadAllText(MessagePairsPath);
            // JSONは配列形式なので、ラッパーを使わずに直接パース
            MessagePairData[] loadedPairs = JsonHelper.FromJson<MessagePairData>(json);
            if (loadedPairs != null)
            {
                pairs.AddRange(loadedPairs);
            }
        }
        catch (System.Exception e)
        {
            Debug.LogError($"[QuoteCardDisplay] JSONパースエラー: {e.Message}");
        }
    }

    private IEnumerator DisplayLoop()
    {
        while (true)
        {
            // ランダムにペアを選択
            int index = Random.Range(0, pairs.Count);
            MessagePairData pair = pairs[index];

            // 表示を更新
            DisplayPair(pair);

            // 待機
            yield return new WaitForSeconds(displayInterval);
        }
    }

    private void DisplayPair(MessagePairData pair)
    {
        // テキスト表示
        if (quoteText != null)
        {
            quoteText.text = $"「{pair.message}」";
        }

        if (authorText != null)
        {
            authorText.text = pair.credit;
        }

        // 画像読み込み
        if (quoteImage != null && !string.IsNullOrEmpty(pair.image))
        {
            string imagePath = Path.Combine(CaptureDir, pair.image);
            StartCoroutine(LoadImageAsync(imagePath));
        }
    }

    private IEnumerator LoadImageAsync(string path)
    {
        if (!File.Exists(path))
        {
            Debug.LogWarning($"[QuoteCardDisplay] 画像が見つかりません: {path}");
            yield break;
        }

        // ファイルから読み込み
        byte[] imageData = File.ReadAllBytes(path);
        Texture2D tex = new Texture2D(2, 2);
        if (tex.LoadImage(imageData))
        {
            quoteImage.texture = tex;
        }
        yield return null;
    }

    private void ClearDisplay()
    {
        if (quoteText != null) quoteText.text = "";
        if (authorText != null) authorText.text = "";
        if (quoteImage != null) quoteImage.texture = null;
    }

    private void StopLoop()
    {
        if (displayCoroutine != null)
        {
            StopCoroutine(displayCoroutine);
            displayCoroutine = null;
        }
    }
}

/// <summary>
/// JSON配列をパースするためのヘルパークラス
/// </summary>
public static class JsonHelper
{
    public static T[] FromJson<T>(string json)
    {
        // Unity's JsonUtility doesn't support top-level arrays directly
        // Wrap the array in an object
        string wrappedJson = "{\"items\":" + json + "}";
        Wrapper<T> wrapper = JsonUtility.FromJson<Wrapper<T>>(wrappedJson);
        return wrapper?.items;
    }

    [System.Serializable]
    private class Wrapper<T>
    {
        public T[] items;
    }
}
